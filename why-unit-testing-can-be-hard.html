<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="author" content="Arnaud Langlade" />
    <meta name="description" content="Software engineer @convelio and former core developer @sylius and @akeneo. Love DDD, BDD, TDD, event storming, example mapping">
    <title>Why unit testing can be hard?</title>
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <link href="css/code-highlight.css" rel="stylesheet" />
    
    <script src="https://getinsights.io/js/insights.js"></script>
    <script>
        insights.init('VoIrQveDE0uUwpQi');
        insights.trackPages({
            hash: true,
            search: true
        });
    </script>
    
</head>

    <body id="page-top">
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top navbar-shrink" id="mainNav">
    <div class="container">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            Menu<i class="fas fa-bars ml-1"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav text-uppercase ml-auto">
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="index.html">About me</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="talks.html">My talks</a></li>
                <li class="nav-item"><a class="nav-link js-scroll-trigger" href="blog.html">Blog</a></li>
            </ul>
        </div>
    </div>
</nav>

        <section class="page-section bg-light">
            <div class="container blog">
                

<style>
    #share-buttons {width: 100%; margin-bottom: 20px;}
    #share-buttons:after {content: ""; display: block; clear: both;}
    #share-buttons > div {float: right;width: 40px;cursor: pointer;}
    #share-buttons > .facebook > svg {fill: #3B5998;}
    #share-buttons > .twitter > svg {fill: #55ACEE;}
    #share-buttons > .linkedin > svg {fill: #0077b5;}
    #share-buttons > .facebook > svg {height: 30px; margin-top: 9px;}
    #share-buttons > .twitter > svg {height: 32px; margin-top: 8px;}
    #share-buttons > .linkedin > svg {height: 31px; margin-top: 7px;margin-left: 3px}
</style>

<div id="share-buttons">
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://arnolanglade.github.io//why-unit-testing-can-be-hard.html&title=title&summary=summary&source=source');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=Why unit testing can be hard?&url=http://arnolanglade.github.io//why-unit-testing-can-be-hard.html&via=arnolanglade');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="facebook" title="Share this on Facebook" onclick="window.open('https://www.facebook.com/share.php?u=http://arnolanglade.github.io//why-unit-testing-can-be-hard.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
</div>
                <h1 id="why-unit-testing-can-be-hard">Why unit testing can be hard?</h1>

<p><img src="assets/img/posts/why-unit-testing-can-be-hard.jpg" alt="Why unit testing can be hard?" />
<a href="https://unsplash.com/@craftedbygc">@craftedbygc</a></p>

<blockquote>
  <p>Unit tests are typically automated tests written and run by software developers to ensure that a section of an application (known as the “unit”) meets its design and behaves as intended</p>

  <p><a href="https://en.wikipedia.org/wiki/Unit_testing">Wikipedia</a></p>
</blockquote>

<p>I remember when I started to test my code it was really hard! It was mainly because I misunderstood some basics like what testing was about and the need of well-designed code. Unit tests ensure your code works as expected, but we often forget that unit testing is also the simplest way to have quick feedback during development phase.</p>

<p>In this blog post, I will share what I learned to easily unit test my codebases.</p>

<h2 id="test-your-public-methods">Test your public methods</h2>

<p>Objects should be seen as black boxes. Public methods are the only way to interact with objects, while private and protected methods are implementation details. We should not pay attention to how objects work internally. That’s why we don’t test private and protected methods. If you need to test them, that’s a design smell! Your objects might do too many things and they probably do not respect the <strong>S</strong>ingle <strong>R</strong>esponsibility <strong>P</strong>rinciple.</p>

<blockquote>
  <p>The single-responsibility principle (SRP) is a computer-programming principle that states that every class in a computer program should have responsibility over a single part of that program’s functionality, which it should encapsulate.</p>

  <p><a href="https://en.wikipedia.org/wiki/Single-responsibility_principle">Wikipedia</a></p>
</blockquote>

<p>Actually, it is better to have several small objects solving simple problems instead of having god objects that are doing everything the wrong way. If your objects become too big, split them into smaller ones because they are easier to maintain and to test.</p>

<h2 id="do-not-unit-test-code-that-uses-ios">Do not unit test code that uses IOs</h2>

<blockquote>
  <p>Input/output (I/O, or informally io or IO) is the communication between an information processing system, such as a computer, and the outside world, possibly a human or another information processing system.</p>

  <p><a href="https://press.rebus.community/programmingfundamentals/chapter/input-and-output/">Wikipedia</a>
k
For example, IO are side effects like: network calls, database queries, filesystem operations, actual timestamps or randomness.</p>
</blockquote>

<h3 id="do-not-deal-with-the-outside">Do not deal with the outside</h3>

<p>The code covered by unit tests should not depend on the outside world like databases, external services and so on. Unit tests should not require any application setup, they have to remain as simple as possible. Their goal is to give you quick feedback by checking that a small piece of code (a unit) matches a business expectation. If you want to be sure that all application parts are well integrated with the outside world, you have to use an integration test.</p>

<p>The following example shows a piece of code that depends on the external service. Here, we can’t build the <code class="language-plaintext highlighter-rouge">Map</code> object without a working database.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">HandleMarkerAddition</span>
<span class="p">{</span>
   <span class="k">private</span> <span class="kt">Connection</span> <span class="nv">$connection</span><span class="p">;</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">Connection</span> <span class="nv">$connection</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span> <span class="o">=</span> <span class="nv">$connection</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">AddMarkerToMap</span> <span class="nv">$command</span><span class="p">):</span> <span class="kt">void</span>
   <span class="p">{</span>
       <span class="nv">$mapState</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span><span class="o">-&gt;</span><span class="nf">executeQuery</span><span class="p">(</span><span class="s1">'SELECT ... FROM ...'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="nf">mapId</span><span class="p">()]);</span>

       <span class="nv">$map</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">::</span><span class="nf">fromState</span><span class="p">(</span><span class="nv">$mapState</span><span class="p">);</span>
       <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">addMarker</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="nf">name</span><span class="p">(),</span> <span class="nv">$command</span><span class="o">-&gt;</span><span class="nf">location</span><span class="p">());</span>

       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span><span class="o">-&gt;</span><span class="nf">executeQuery</span><span class="p">(</span><span class="s1">'INSERT INTO ...'</span><span class="p">,</span> <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">toState</span><span class="p">()]);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The goal of this piece of code is to add a marker to a <code class="language-plaintext highlighter-rouge">Map</code> object, no matter how the object is stored. Tests that cover this class should focus on business use cases instead of technical details. A solution would be to use a repository design pattern to hide the map storage logic. The class will better follow the <strong>S</strong>ingle <strong>R</strong>esponsable <strong>P</strong>rinciple because it will only handle the marker addition use case whereas the map repository will be in charge of storing data.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">HandleMarkerAddition</span>
<span class="p">{</span>
   <span class="k">private</span> <span class="kt">Maps</span> <span class="nv">$maps</span><span class="p">;</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">Maps</span> <span class="nv">$maps</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">maps</span> <span class="o">=</span> <span class="nv">$maps</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">AddMarkerToMap</span> <span class="nv">$command</span><span class="p">):</span> <span class="kt">void</span>
   <span class="p">{</span>
       <span class="nv">$map</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">maps</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="nf">mapId</span><span class="p">());</span>
       <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">addMarker</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="nf">name</span><span class="p">(),</span> <span class="nv">$command</span><span class="o">-&gt;</span><span class="nf">location</span><span class="p">());</span>

       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">maps</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$map</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With this new design, it is easier to test this class. Thanks to the <code class="language-plaintext highlighter-rouge">Maps</code> interface , we are able to simply create test doubles for the map repository.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// `PostgreSQLMaps` is the implementation used by default on the production</span>
<span class="nv">$maps</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PostgreSQLMaps</span><span class="p">();</span>
<span class="p">(</span><span class="k">new</span> <span class="nc">HandleMarkerAddition</span><span class="p">(</span><span class="nv">$postgreSQLMaps</span><span class="p">)(</span><span class="nv">$command</span><span class="p">);</span>

<span class="c1">// `InMemoryMaps` is an implementation that keeps map objects in memory for testing </span>
<span class="nv">$maps</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryMaps</span><span class="p">();</span>
<span class="p">(</span><span class="k">new</span> <span class="nc">HandleMarkerAddition</span><span class="p">(</span><span class="nv">$inMemoryMaps</span><span class="p">)(</span><span class="nv">$command</span><span class="p">);</span>

<span class="c1">// In both cases we can retrieve the Map object from the repository to check the map has the new marker.</span>
<span class="nv">$map</span> <span class="o">=</span> <span class="nv">$maps</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="nf">mapId</span><span class="p">());</span>
<span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">hasSameState</span><span class="p">(</span><span class="k">new</span> <span class="nc">Map</span><span class="p">(</span><span class="s1">'Best place'</span><span class="p">,</span> <span class="k">new</span> <span class="nc">Marker</span><span class="p">(</span><span class="cm">/* … */</span><span class="p">)))</span> <span class="c1">// should return true;</span>

</code></pre></div></div>

<h3 id="do-not-deal-with-randomness">Do not deal with randomness</h3>

<p>Randomness makes your code unpredictable. To simply test a piece of code you should be able to predict its result. To ease unit testing your code should avoid using randomness as much as possible.</p>

<p>The following example shows a piece of code that uses randomness.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">HashedPassword</span>
<span class="p">{</span>
   <span class="c1">// ... </span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$hash</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="nv">$hash</span><span class="p">;</span>
   <span class="p">}</span>


   <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromString</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$password</span><span class="p">):</span> <span class="kt">self</span>
   <span class="p">{</span>
       <span class="nv">$hash</span> <span class="o">=</span> <span class="err">\</span><span class="nb">password_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="no">PASSWORD_BCRYPT</span><span class="p">);</span>

       <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span><span class="nv">$hash</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HashedPasswordTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="cd">/** @test */</span>
    <span class="k">function</span> <span class="n">it</span><span class="err"> </span><span class="n">builds</span><span class="err"> </span><span class="n">a</span><span class="err"> </span><span class="n">password</span><span class="err"> </span><span class="n">from</span><span class="err"> </span><span class="n">a</span><span class="err"> </span><span class="nf">string</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="s1">'Password1'</span><span class="p">),</span>
            <span class="k">new</span> <span class="nc">HashedPassword</span><span class="p">(</span><span class="s1">'$2y$10$JqfiXNdcuWErfiy5pAJ4O.wKsfic14RsVnVbP/rsdMJJyA9Hg9RCu'</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When we run <code class="language-plaintext highlighter-rouge">HashedPasswordTest</code> we get an error because the <code class="language-plaintext highlighter-rouge">password_hash</code> generates a random salt to hash the password. The problem is that the <code class="language-plaintext highlighter-rouge">password_hash</code> function cannot return the same hash for a given password. Each time you call this function a different hash will be returned.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Password</span> Object &amp;000000006e7168e60000000023b11bb2 <span class="o">(</span>
-    <span class="s1">'hash'</span> <span class="o">=&gt;</span> <span class="s1">'$2y$10$JqfiXNdcuWErfiy5pAJ4O.wKsfic14RsVnVbP/rsdMJJyA9Hg9RCu'</span>
+Password Object &amp;000000006e7168210000000023b11bb2 <span class="o">(</span>
+    <span class="s1">'hash'</span> <span class="o">=&gt;</span> <span class="s1">'$2y$10$b/9GX4grnt4gH5cm8FzzSuUNGGQUiA/w.5HdKNEsW3dHtSUeTMXgK'</span>
</code></pre></div></div>

<p>The simplest solution would be to hardcode the salt to make sure the <code class="language-plaintext highlighter-rouge">hash_password</code> returns the same hash every time but this is not a good design. This would weaken the password generation because we need to test it. Another way would be to extract the hash generation in another place.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">HashedPassword</span>
<span class="p">{</span>
   <span class="c1">// ...</span>
   <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromString</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$password</span><span class="p">,</span> <span class="kt">PasswordEncryptor</span> <span class="nv">$passwordEncryptor</span><span class="p">):</span> <span class="kt">self</span>
   <span class="p">{</span>
       <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$passwordEncryptor</span><span class="o">-&gt;</span><span class="nb">hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

       <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span><span class="nv">$hash</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">PasswordEncryptor</code> interface makes test doubles creation possible. Now, we just need to create a fake object to test this method.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">FakePawssordEncryptor</span> <span class="kd">implements</span> <span class="nc">PasswordEncryptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">hash</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'$2y$10$JqfiXNdcuWErfiy5pAJ4O.wKsfic14RsVnVbP/rsdMJJyA9Hg9RCu'</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HashedPasswordTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
   <span class="cd">/** @test */</span>
   <span class="k">function</span> <span class="n">it</span><span class="err"> </span><span class="n">builds</span><span class="err"> </span><span class="n">a</span><span class="err"> </span><span class="n">password</span><span class="err"> </span><span class="n">from</span><span class="err"> </span><span class="n">a</span><span class="err"> </span><span class="nf">string</span><span class="p">()</span>
   <span class="p">{</span>
        <span class="nv">$fakePasswordEncryptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FakePasswordEncryptor</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span>
            <span class="n">this</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="s1">'Password1'</span><span class="p">,</span> <span class="nv">$fakePasswordEncryptor</span><span class="p">),</span>
            <span class="k">new</span> <span class="nc">HashedPassword</span><span class="p">(</span><span class="s1">'$2y$10$JqfiXNdcuWErfiy5pAJ4O.wKsfic14RsVnVbP/rsdMJJyA9Hg9RCu'</span><span class="p">)</span>
        <span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="avoid-actual-datetimes">Avoid actual datetimes</h3>

<p>With actual datetimes, we have the same problem as with randomness, neither can be predicted.</p>

<p>The following example shows you that actual datetimes are not predictable like <code class="language-plaintext highlighter-rouge">hash_password</code> in the previous section.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">Map</span>
<span class="p">{</span>
   <span class="c1">// ...</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="err">\</span><span class="nc">DateTimeImmutable</span> <span class="nv">$markerAddedAt</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nc">Marker</span> <span class="mf">...</span><span class="nv">$makers</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">// ...</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="k">function</span> <span class="n">addMarker</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$location</span><span class="p">):</span> <span class="kt">void</span>
   <span class="p">{</span>
       <span class="c1">// ...</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">markerAddedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">DateTimeImmutable</span><span class="p">(</span><span class="s1">'now'</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MapTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="cd">/** @test */</span>
    <span class="k">function</span> <span class="n">it</span><span class="err"> </span><span class="n">adds</span><span class="err"> </span><span class="n">marker</span><span class="err"> </span><span class="n">to</span><span class="err"> </span><span class="n">the</span><span class="err"> </span><span class="nf">map</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Map</span><span class="p">(</span><span class="s1">'Map name'</span><span class="p">);</span>
        <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">addMarker</span><span class="p">(</span><span class="s1">'Bubar'</span><span class="p">,</span> <span class="p">[</span><span class="mf">47.21725</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.55336</span><span class="p">]);</span>
        
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assetTrue</span><span class="p">(</span>
            <span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">hasSameState</span><span class="p">(</span>
                <span class="k">new</span> <span class="nc">Map</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nc">Marker</span><span class="p">(</span><span class="s1">'Bubar'</span><span class="p">,</span> <span class="p">[</span><span class="mf">47.21725</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.55336</span><span class="p">]),</span> 
                    <span class="k">new</span> <span class="err">\</span><span class="nf">DateTimeImmutable</span><span class="p">(</span><span class="s1">'now'</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When we run <code class="language-plaintext highlighter-rouge">MapTest</code> we get an error because we can predict to the millisecond when the marker was added to the map.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Map</span> Object &amp;000000003acad975000000006b83e943 <span class="o">()</span>
+Map Object &amp;000000003acad936000000006b83e943 <span class="o">(</span>
+    <span class="s1">'markerAddedAt'</span> <span class="o">=&gt;</span> DateTimeImmutable Object &amp;000000003acad946000000006b83e943 <span class="o">(</span>
+        <span class="s1">'date'</span> <span class="o">=&gt;</span> <span class="s1">'2021-04-18 17:36:02.919004'</span>
+        <span class="s1">'timezone_type'</span> <span class="o">=&gt;</span> 3
+        <span class="s1">'timezone'</span> <span class="o">=&gt;</span> <span class="s1">'UTC'</span>
+    <span class="o">)</span>
+<span class="o">)</span>
</code></pre></div></div>

<p>To prevent this kind of problem, a good idea is to abstract time by introducing an interface that is responsible for time management.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">Map</span>
<span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">addMarker</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$location</span><span class="p">,</span> <span class="kt">Clock</span> <span class="nv">$clock</span><span class="p">):</span> <span class="kt">void</span>
  <span class="p">{</span>
      <span class="c1">// ...</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">markerAddedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$clock</span><span class="o">-&gt;</span><span class="nf">now</span><span class="p">();</span>
  <span class="p">}</span>
   <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, thanks to the <code class="language-plaintext highlighter-rouge">Clock</code> interface we will be able to create test doubles and easily test this method.</p>

<h2 id="coupling-might-be-your-worst-enemy">Coupling might be your worst enemy</h2>

<blockquote>
  <p>Coupling is the degree of interdependence between software modules; a measure of how closely connected two routines or modules are; the strength of the relationships between modules.</p>

  <p><a href="https://en.wikipedia.org/wiki/Coupling_(computer_programming)">Wikipedia</a></p>
</blockquote>

<p>As you have seen in the previous sections, objects should depend on abstractions instead of concrete implementations. Abstractions (e.g. interfaces) ease testing because your code is more modular. You can use test doubles to reduce the complexity and facilitate testing. Their goal is to mimic the behavior of real objects to replace a subpart of an algorithm.</p>

<p>The following example shows that hardcoding object dependencies won’t help to create test doubles.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyClass</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ConcreteImplementation</span> <span class="nv">$concreteImplementation</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">// Here we can only use these concrete implementations, if they use IO for instance you won't be able to test it.</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">concreteImplementation</span> <span class="o">=</span> <span class="nv">$concreteImplementation</span><span class="p">;</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">anotherConcreteImplementation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnotherConcreteImplementation</span><span class="p">();</span>
      
       <span class="c1">// Singleton pattern does not help because it hides object dependencies and makes them hard coded.</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span> <span class="o">=</span> <span class="nc">Connection</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The solution is to use the dependency inversion pattern to remove hard coded dependencies introducing abstractions as much as possible.</p>

<blockquote>
  <p>High-level modules should not depend on low-level modules. Both should depend on abstractions (e.g., interfaces). Abstractions should not depend on details. Details (concrete implementations) should depend on abstractions.</p>

  <p><a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">Wikipedia</a></p>
</blockquote>

<p>In the following example, all class dependencies are interchangeable. So, you can easily create test doubles like fake, stub, or mocks to make sure your objects meet business expectations.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyClass</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
       <span class="kt">ImplementationInterface</span> <span class="nv">$concreteImplementation</span><span class="p">,</span>
       <span class="kt">AnoherImplementationInterface</span> <span class="nv">$anotherConcreteImplementation</span><span class="p">,</span>
       <span class="kt">ConnectionInterface</span> <span class="nv">$connection</span>
   <span class="p">)</span> <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">concreteImplementation</span> <span class="o">=</span> <span class="nv">$concreteImplementation</span><span class="p">;</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">anotherConcreteImplementation</span> <span class="o">=</span> <span class="nv">$anotherConcreteImplementation</span><span class="p">;</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span> <span class="o">=</span> <span class="nv">$connection</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Caution:</strong> That does not mean you should use interfaces everywhere! Knowing when to introduce new abstractions might be hard at the beginning, there is no magic recipe!</p>

<p>Thanks to my proofreaders <a href="https://twitter.com/LaureBrosseau">@LaureBrosseau</a> and <a href="https://twitter.com/jjanvier_">@jjanvier_</a>.</p>

                

<style>
    #share-buttons {width: 100%; margin-bottom: 20px;}
    #share-buttons:after {content: ""; display: block; clear: both;}
    #share-buttons > div {float: right;width: 40px;cursor: pointer;}
    #share-buttons > .facebook > svg {fill: #3B5998;}
    #share-buttons > .twitter > svg {fill: #55ACEE;}
    #share-buttons > .linkedin > svg {fill: #0077b5;}
    #share-buttons > .facebook > svg {height: 30px; margin-top: 9px;}
    #share-buttons > .twitter > svg {height: 32px; margin-top: 8px;}
    #share-buttons > .linkedin > svg {height: 31px; margin-top: 7px;margin-left: 3px}
</style>

<div id="share-buttons">
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://arnolanglade.github.io//why-unit-testing-can-be-hard.html&title=title&summary=summary&source=source');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=Why unit testing can be hard?&url=http://arnolanglade.github.io//why-unit-testing-can-be-hard.html&via=arnolanglade');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="facebook" title="Share this on Facebook" onclick="window.open('https://www.facebook.com/share.php?u=http://arnolanglade.github.io//why-unit-testing-can-be-hard.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
</div>

                
                <div class="related-post">
                    <h1>Related posts</h1>
                    <div class="row">
                        
                            
                        
                            
                        
                            
                            <div class="col-lg-3 col-sm-6 mb-3">
                                <div class="portfolio-item">
                                    <a class="portfolio-link text-black" href="/you-should-not-expose-objects-state-to-test-them.html">
                                        <img class="img-fluid" src="assets/img/posts/test-comparison.jpg" alt="Why you should not expose objects' state to test them"/>
                                        <div class="portfolio-caption">
                                            <div class="portfolio-caption-heading">Why you should not expose objects' state to test them</div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            
                        
                            
                        
                            
                        
                            
                        
                            
                        
                            
                        
                    </div>
                </div>
                
            </div>
        </section>
        <footer class="footer py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-4 text-lg-left">Copyright © Arnaud Langlade</div>
            <div class="col-lg-4 my-3 my-lg-0">
                <a href="https://twitter.com/arnolanglade" class="btn btn-dark btn-social mx-2" target="_blank"><i class="fab fa-twitter"></i></a>
                <a href="https://github.com/arnolanglade" class="btn btn-dark btn-social mx-2" target="_blank"><i class="fab fa-github"></i></a>
                <a href="https://gitlab.com/arnolanglade" class="btn btn-dark btn-social mx-2" target="_blank"><i class="fab fa-gitlab"></i></a>
                <a href="https://www.linkedin.com/in/arnaudlanglade" class="btn btn-dark btn-social mx-2" target="_blank"><i class="fab fa-linkedin"></i></a>
            </div>
        </div>
    </div>
</footer>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<!-- Third party plugin JS-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
<!-- Core theme JS-->
<script src="./js/scripts.js"></script>
    </body>
</html>